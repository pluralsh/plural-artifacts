{{- if and (eq .Values.provider "azure") (eq .Values.type "managed") -}}
{{- $currentScope := . -}}
{{- $defaultVals := .Values.workers.defaults.azure -}}
{{- range $name, $values := .Values.workers.azure }}
{{- with $currentScope}}
{{- $scaling := ($values.spec | default dict).scaling | default $defaultVals.spec.scaling }}
{{- if $scaling }}
{{- if not (and (hasKey $scaling "minSize") (hasKey $scaling "maxSize")) }}
  {{- fail (printf "Invalid value for scaling. Both minSize and maxSize must be set") }}
{{- end }}
{{- end }}
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureManagedMachinePool
metadata:
  annotations:
    {{- if (hasKey $values "annotations") -}}
    {{- toYaml (merge $values.annotations $defaultVals.annotations)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.annotations | nindent 4 }}
    {{- end }}
  labels:
    {{- if (hasKey $values "labels") -}}
    {{- toYaml (merge $values.labels $defaultVals.labels)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.labels | nindent 4 }}
    {{- end }}
  name: {{ $name }}
spec:
  name: {{ $name }}
  additionalTags:
    {{- if (dig "spec" "additionalTags" $values) -}}
    {{- toYaml (merge $values.spec.additionalTags $defaultVals.spec.additionalTags)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.spec.additionalTags | nindent 4 }}
    {{- end }}
  mode: {{ ($values.spec | default dict).mode | default $defaultVals.spec.mode }}
  sku: {{ ($values.spec | default dict).sku | default $defaultVals.spec.sku }}
  osDiskSizeGB: {{ ($values.spec | default dict).osDiskSizeGB | default $defaultVals.spec.osDiskSizeGB }}
  {{- if or ($defaultVals.spec.availabilityZones) (($values.spec | default dict).availabilityZones) }}
  availabilityZones:
    {{- toYaml (($values.spec | default dict).availabilityZones | default $defaultVals.spec.availabilityZones) | nindent 2 }}
  {{- end }}
  nodeLabels:
    {{- if (dig "spec" "nodeLabels" $values) -}}
    {{- toYaml (merge $values.spec.nodeLabels $defaultVals.spec.nodeLabels)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.spec.nodeLabels | nindent 4 }}
    {{- end }}
  {{- if or ($defaultVals.spec.taints) (($values.spec | default dict).taints) }}
  taints:
  {{- toYaml (($values.spec | default dict).taints | default $defaultVals.spec.taints) | nindent 2 }}
  {{- end }}
  {{- if $scaling }}
  scaling:
    {{- toYaml $scaling | nindent 4 }}
  {{- end }}
  maxPods: {{ ($values.spec | default dict).maxPods | default $defaultVals.spec.maxPods }}
  osDiskType: {{ ($values.spec | default dict).osDiskType | default $defaultVals.spec.osDiskType }}
  scaleSetPriority: {{ ($values.spec | default dict).maxPods | default $defaultVals.spec.scaleSetPriority }}
  osType: {{ ($values.spec | default dict).osType | default $defaultVals.spec.osType }}
  enableNodePublicIP: {{ ($values.spec | default dict).enableNodePublicIP | default $defaultVals.spec.enableNodePublicIP }}
  nodePublicIPPrefixID: {{ ($values.spec | default dict).nodePublicIPPrefixID | default $defaultVals.spec.nodePublicIPPrefixID }}
  {{- if or ($defaultVals.spec.kubeletConfig) (($values.spec | default dict).kubeletConfig) }}
  kubeletConfig:
    {{- toYaml (($values.spec | default dict).kubeletConfig | default $defaultVals.spec.kubeletConfig) | nindent 2 }}
  {{- end }}
  {{- if or ($defaultVals.spec.linuxOSConfig) (($values.spec | default dict).linuxOSConfig) }}
  linuxOSConfig:
    {{- toYaml (($values.spec | default dict).linuxOSConfig | default $defaultVals.spec.linuxOSConfig) | nindent 2 }}
  {{- end }}
{{- end }}
---
{{- end }}
{{ end }}
